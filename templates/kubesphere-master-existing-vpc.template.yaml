AWSTemplateFormatVersion: "2010-09-09"
Description: Deploy KubeSphere into a new EKS cluster in an existing VPC (qs-1qtdde8ck).
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: Network configuration
      Parameters:
        - VPCID
        - PrivateSubnet1ID
        - PrivateSubnet2ID
        - PrivateSubnet3ID
        - PublicSubnet1ID
        - PublicSubnet2ID
        - PublicSubnet3ID
        - RemoteAccessCIDR
    - Label:
        default: Amazon EC2 configuration
      Parameters:
      - KeyPairName
    - Label:
        default: EKS configuration
      Parameters:
      - NodeInstanceType
      - NumberOfNodes
      - NodeGroupName
      - NodeVolumeSize
      - KubernetesVersion
      - AdditionalEKSAdminUserArn
      - AdditionalEKSAdminRoleArn
    - Label:
        default: AWS Quick Start configuration
      Parameters:
      - QSS3BucketName
      - QSS3KeyPrefix
      - QSS3BucketRegion
      - LambdaZipsBucketName
    - Label:
        default: KubeSphere Quick Start True/False configuration
      Parameters:
      - Openpitrix  
      - Devops
      - Servicemesh
      - Notification
      - Alerting
      - Auditing
      - Logging
      - Events
      - Multicluster
      - Networkpolicy
      - MetricServer
    ParameterLabels:
      KeyPairName:
        default: SSH key name
      QSS3BucketName:
        default: Quick Start S3 bucket name
      QSS3KeyPrefix:
        default: Quick Start S3 key prefix
      QSS3BucketRegion:
        default: Quick Start S3 bucket region
      RemoteAccessCIDR:
        default: Allowed external access CIDR
      NodeInstanceType:
        default: Nodes instance type
      NumberOfNodes:
        default: Number of nodes
      NodeGroupName:
        default: Node group name
      NodeVolumeSize:
        default: Node volume size
      AdditionalEKSAdminUserArn:
        Default: ""
      AdditionalEKSAdminRoleArn:
        Default: ""
      LambdaZipsBucketName:
        default: Lambda zips bucket name
      PublicSubnet1ID:
        default: Public subnet 1 ID
      PublicSubnet2ID:
        default: Public subnet 2 ID
      PublicSubnet3ID:
        default: Public subnet 3 ID
      PrivateSubnet1ID:
        default: Private subnet 1 ID
      PrivateSubnet2ID:
        default: Private subnet 2 ID
      PrivateSubnet3ID:
        default: Private subnet 3 ID
      VPCID:
        default: VPC ID
      KubernetesVersion:
        default: Kubernetes version
      #KubeSphereKey:
      #  default: KubeSphere license key
      Openpitrix:
        default: Openpitrix
      Devops:
        default: Devops
      Servicemesh:
        default: Servicemesh
      Notification:
        default: Notification
      Alerting:
        default: Alerting
      Logging:
        default: Logging
      Auditing:
        default: Auditing
      Events:
        default: Events
      Multicluster:
        default: Multicluster
      Networkpolicy:
        default: Networkpolicy
      MetricServer:
        default: MetricServer
Parameters:
  KeyPairName:
    Description: Enter the public/private key pair you created in your preferred AWS Region; see the Technical requirements section of the deployment guide.
      to securely connect to your instance after it launches.
    Type: AWS::EC2::KeyPair::KeyName
  QSS3BucketName:
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: Quick Start bucket name can include numbers, lowercase
      letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen
      (-).
    Default: quickstart-eks-kubesphere
    Description: S3 bucket name for the Quick Start assets. This string can include
      numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start
      or end with a hyphen (-).
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: ^[0-9a-zA-Z-/]*$
    ConstraintDescription: Quick Start key prefix can include numbers, lowercase letters,
      uppercase letters, hyphens (-), and forward slash (/).
    Default: ks/
    Description: S3 key prefix for the Quick Start assets. Quick Start key prefix
      can include numbers, lowercase letters, uppercase letters, hyphens (-), and
      forward slash (/).
    Type: String
  QSS3BucketRegion:
    Default: 'us-east-1'
    Description: The AWS Region where the Quick Start S3 bucket (QSS3BucketName) is hosted. When using your own bucket, you must specify this value.
    Type: String
  RemoteAccessCIDR:
    Default: "139.198.0.0/16"
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/x
    Description: The CIDR IP range that is permitted to access the instances. We recommend that you set this value to a trusted IP range.
    Type: String
  AdditionalEKSAdminUserArn:
    Default: ""
    Description: "[OPTIONAL] Comma separated list of IAM users to be granted admin access to the EKS cluster"
    Type: String
  AdditionalEKSAdminRoleArn:
    Default: ""
    Description: "[OPTIONAL] Comma separated list of IAM roles to be granted admin access to the EKS cluster"
    Type: String
  NodeInstanceType:
    Default: t3.xlarge
    AllowedValues:
      - t3.nano
      - t3.micro
      - t3.small
      - t3.medium
      - t3.large
      - t3.xlarge
      - t3.2xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5.12xlarge
      - m5.24xlarge
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5.9xlarge
      - c5.18xlarge
      - i3.large
      - i3.xlarge
      - i3.2xlarge
      - i3.4xlarge
      - i3.8xlarge
      - i3.16xlarge
      - x1.16xlarge
      - x1.32xlarge
      - p3.2xlarge
      - p3.8xlarge
      - p3.16xlarge
      - r5.large
      - r5.xlarge
      - r5.2xlarge
      - r5.4xlarge
      - r5.12xlarge
      - r5.24xlarge
      - r5d.large
      - r5d.xlarge
      - r5d.2xlarge
      - r5d.4xlarge
      - r5d.12xlarge
      - r5d.24xlarge
      - z1d.large
      - z1d.xlarge
      - z1d.2xlarge
      - z1d.3xlarge
      - z1d.6xlarge
      - z1d.12xlarge
    ConstraintDescription: Must be a valid EC2 instance type.
    Description: The type of EC2 instance for the node instances.
    Type: String
  NumberOfNodes:
    Default: 1
    Description: The number of Amazon EKS node instances. The default is one for each of the three Availability Zones.
    Type: Number
  NodeGroupName:
    Default: Default
    Description: The name for Amazon EKS node group.
    Type: String
  NodeVolumeSize:
    Default: 100
    Description: The size for the node's root EBS volume.
    Type: String
  LambdaZipsBucketName:
    Description: '[OPTIONAL] The name of the S3 bucket where the Lambda zip files should be placed. If you leave this parameter blank, an S3 bucket will be created.'
    Type: String
    Default: ''
  VPCID:
    Type: "AWS::EC2::VPC::Id"
    Description: The ID of your existing VPC (e.g., vpc-0343606e)
  PublicSubnet1ID:
    Type: "AWS::EC2::Subnet::Id"
    Description: The ID of the public subnet in Availability Zone 1 in your existing VPC (e.g., subnet-a0246dcd)
  PublicSubnet2ID:
    Type: "AWS::EC2::Subnet::Id"
    Description: The ID of the public subnet in Availability Zone 2 in your existing VPC (e.g., subnet-b1236eea)
  PublicSubnet3ID:
    Type: "AWS::EC2::Subnet::Id"
    Description: The ID of the public subnet in Availability Zone 3 in your existing VPC (e.g., subnet-c3456aba)
  PrivateSubnet1ID:
    Type: "AWS::EC2::Subnet::Id"
    Description: The ID of the private subnet in Availability Zone 1 in your existing VPC (e.g., subnet-fe9a8b32)
  PrivateSubnet2ID:
    Type: "AWS::EC2::Subnet::Id"
    Description: The ID of the private subnet in Availability Zone 2 in your existing VPC (e.g., subnet-be8b01ea)
  PrivateSubnet3ID:
    Type: "AWS::EC2::Subnet::Id"
    Description: The ID of the private subnet in Availability Zone 3 in your existing VPC (e.g., subnet-abd39039)
  KubernetesVersion:
    Type: String
    AllowedValues: [ "1.16", "1.15" ]
    Default: "1.16"
    Description: The Kubernetes control plane version.
  #KubeSphereLicenseKey:
   # Type: String
   # NoEcho: true
   # Description: The KubeSphere license key to use.
  Openpitrix:
    Type: String
    AllowedValues: [true, false]
    Default: false
    Description: '[OPTIONAL] An application store to package, deploy and manage cloud native applications into multi-cloud environment.'
  Devops:
    Type: String
    AllowedValues: [true, false]
    Default: false
    Description: '[OPTIONAL] Provides out-of-box CI/CD based on Jenkins, and offers automated workflow tools including binary-to-image (B2I) and source-to-image (S2I).'
  Servicemesh:
    Type: String
    AllowedValues: [true, false]
    Default: false
    Description: '[OPTIONAL] Provides fine-grained traffic management, observability and tracing for distributed microservice applications, and provides visualization for traffic topology.'
  Notification:
    Type: String
    AllowedValues: [true, false]
    Default: false
    Description: '[OPTIONAL] Sends alert messages to specified responders via email, slack, wechat etc.'
  Alerting:
    Type: String
    AllowedValues: [true, false]
    Default: false
    Description: '[OPTIONAL] Users can customize alerting policies to send messages to users in time with different time intervals and alerting levels to choose from.'
  Events:
    Type: String
    AllowedValues: [true, false]
    Default: false
    Description: '[OPTIONAL] Events that happen inside a cluster are recorded, such as container running status, image pulling failures and node scheduling activities.'
  Logging:
    Type: String
    AllowedValues: [true, false]
    Default: false
    Description: '[OPTIONAL] Flexible logging functions are provided for query, collection and management. Additional log collectors can be added, such as Elasticsearch, Kafka and Fluentd.'
  Multicluster:
    Type: String
    AllowedValues: [none, host, member]
    Default: none
    Description: '[OPTIONAL] Users can create projects to run across clusters, building a container environment for rapid iteration of applications and achieve high availability.'
  Networkpolicy:
    Type: String
    AllowedValues: [true, false]
    Default: false
    Description: '[OPTIONAL] The Network policy configuration allows network isolation within the same cluster, which means firewalls can be set up between certain Pods.'
  Auditing:
    Type: String
    AllowedValues: [true, false]
    Default: false
    Description: '[OPTIONAL] A one-stop DevOps console is provided to enable developers to create, build, test and release their applications in an automated way.'
  MetricServer:
    Type: String
    AllowedValues: [true, false]
    Default: false
    Description: '[OPTIONAL] Users can install metrics-server to enable HPA (Horizontal Pod Autoscaler) which automatically scales the number of pods, deployments, or stateful sets based on observed CPU utilization.'
Conditions:
  UsingDefaultBucket: !Equals [!Ref QSS3BucketName, 'aws-quickstart']
Resources:
  EKSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}submodules/quickstart-amazon-eks/templates/amazon-eks.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        PublicSubnet1ID: !Ref PublicSubnet1ID
        PublicSubnet2ID: !Ref PublicSubnet2ID
        PublicSubnet3ID: !Ref PublicSubnet3ID
        KeyPairName: !Ref KeyPairName
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Sub "${QSS3KeyPrefix}submodules/quickstart-amazon-eks/"
        PrivateSubnet1ID: !Ref PrivateSubnet1ID
        PrivateSubnet2ID: !Ref PrivateSubnet2ID
        PrivateSubnet3ID: !Ref PrivateSubnet3ID
        NumberOfNodes: !Ref NumberOfNodes
        NodeGroupName: !Ref NodeGroupName
        NodeVolumeSize: !Ref NodeVolumeSize
        LambdaZipsBucketName: !Ref LambdaZipsBucketName
        NodeInstanceType: !Ref NodeInstanceType
        RemoteAccessCIDR: !Ref RemoteAccessCIDR
        AdditionalEKSAdminUserArn: !Ref AdditionalEKSAdminUserArn
        AdditionalEKSAdminRoleArn: !Ref AdditionalEKSAdminRoleArn
        VPCID: !Ref VPCID
        KubernetesVersion: !Ref KubernetesVersion
       # BastionBootstrapScript: !Sub
        #  - 'https://${S3Bucket}.s3.${S3Region}.amazonaws.com/${QSS3KeyPrefix}scripts/bastion_bootstrap.sh'
         # - S3Region: !Ref QSS3BucketRegion
          #  S3Bucket: !Ref QSS3BucketName
  KubeSphereStack:
    DependsOn: EKSStack
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/kubesphere.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        KubeClusterName: !GetAtt EKSStack.Outputs.EKSClusterName
        KubeConfigKmsContext: "EKSQuickStart"
        Openpitrix: !Ref Openpitrix
        Devops: !Ref Devops
        Servicemesh: !Ref Servicemesh
        Notification: !Ref Notification
        Alerting: !Ref Alerting
        Logging: !Ref Logging
        Auditing: !Ref Auditing
        Events: !Ref Events
        Networkpolicy: !Ref Networkpolicy
        MetricServer: !Ref MetricServer
        Multicluster: !Ref Multicluster
        KubeManifestLambdaArn: !GetAtt EKSStack.Outputs.KubeManifestLambdaArn
        KubeGetLambdaArn: !GetAtt EKSStack.Outputs.KubeGetLambdaArn
        #KubeSphereLicenseKey: !Ref KubeSphereLicenseKey
Outputs:
  KubeConfigPath:
    Value: !GetAtt EKSStack.Outputs.KubeConfigPath
  BastionIP:
    Value: !GetAtt EKSStack.Outputs.BastionIP
